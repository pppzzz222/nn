# 车道线预测轻量化程序（智能驾驶课程项目）
本项目是基于openpilot的supercombo模型实现的车道线预测轻量化程序，针对虚拟机低资源环境做了专项优化，仅依赖基础Python库即可运行，核心功能为视频帧读取→预处理→模型推理→轻量化可视化。

## 一、项目简介
### 核心特性
1. **轻量化优化**：视频读取帧数限制为10帧，可视化仅保留单窗口+线条更新，降低虚拟机计算/渲染压力；
2. **鲁棒性保障**：全流程异常捕获（视频/模型路径错误、帧读取失败等），给出明确中文提示；
3. **适配性强**：兼容openpilot的eon/medmodel相机内参转换，支持主流MP4视频格式。

### 核心流程
```
原始视频（MP4）→ YUV_I420格式转换 → 相机内参适配 → 6通道张量生成 → supercombo模型推理 → 车道线/路径可视化
```

## 二、环境配置
### 1. 基础依赖（指定版本，避免兼容问题）
```bash
# 核心依赖
pip install numpy==1.24.3 opencv-python==4.8.1.78 tensorflow==2.15.0 matplotlib==3.7.2 tqdm==4.66.1
# 视频解码依赖（必装）
sudo apt install ffmpeg
```

### 2. 模型准备
将预训练的`supercombo.h5`模型文件放置到项目目录下的`models/`文件夹，目录结构如下：
```
nn/
├── models/
│   └── supercombo.h5  # 车道线预测核心模型
├── src/
│   └── openpilot_model/
│       └── main.py     # 主程序文件
├── common/             # 相机/模型变换工具库（openpilot依赖）
└── README.md           # 本说明文件
```

## 三、快速使用
### 1. 运行命令
```bash
# 进入项目根目录
cd ~/nn
# 执行预测（替换为你的视频文件路径）
python src/openpilot_model/main.py <视频文件路径>.mp4
```

### 2. 示例
```bash
python src/openpilot_model/main.py test_video.mp4
```

### 3. 交互说明
- 程序运行后会显示两个窗口：`车道线预测`（蓝=左车道、红=右车道、绿=预测路径）、`原始帧`（缩小版原始视频帧）；
- 按`Q`键可随时退出程序，自动释放所有资源。

## 四、核心功能模块说明
| 函数名                | 功能说明                                                                 |
|-----------------------|--------------------------------------------------------------------------|
| `frames_to_tensor`    | 将YUV帧转换为supercombo模型所需的6通道张量，归一化至[-1, 1]              |
| `preprocess_frames`   | 帧预处理：转换相机内参（eon→medmodel）、格式转换、异常帧填充             |
| `read_video_with_opencv` | 轻量化读取视频帧（限制10帧），转换为YUV_I420格式并调整尺寸               |
| `main`                | 主程序入口：参数校验→模型加载→帧预处理→逐帧推理→轻量化可视化             |

## 五、轻量化优化点
1. **帧数限制**：视频读取仅保留10帧，减少内存占用；
2. **可视化优化**：单窗口仅更新线条数据，不重绘整个画布，降低CPU压力；
3. **尺寸缩小**：原始帧显示窗口缩至480×270，减少渲染资源消耗；
4. **静默推理**：模型预测关闭日志输出（`verbose=0`），提升运行速度。

## 六、常见问题解决
### 1. 视频无法打开
- 错误提示：`无法打开视频：xxx.mp4，请安装FFmpeg`
- 解决：执行`sudo apt install ffmpeg`安装视频解码库，确保视频格式为MP4。

### 2. 模型加载失败
- 错误提示：`模型文件不存在 - models/supercombo.h5`
- 解决：确认`supercombo.h5`文件放置在`models/`目录下，路径无拼写错误。

### 3. 预处理无有效数据
- 错误提示：`预处理无有效数据`
- 解决：检查视频是否损坏，或尝试更换其他MP4格式视频（分辨率建议1080P以内）。

### 4. 虚拟机卡顿
- 解决：关闭其他无关程序，或进一步将`read_video_with_opencv`的`max_frames`改为5帧。

## 七、注意事项
1. 本程序仅用于课程学习，请勿用于实际驾驶场景；
2. 模型文件（supercombo.h5）需自行获取，确保与代码版本兼容；
3. 运行前请确认虚拟机已安装所有依赖库，版本与要求一致；
4. 程序退出时会自动释放Matplotlib/OpenCV窗口资源，无需手动清理。

## 八、更新日志
- v1.0：实现基础车道线预测功能，适配虚拟机轻量化运行；
- v1.1：补充核心函数注释，优化异常提示，提升代码可读性。